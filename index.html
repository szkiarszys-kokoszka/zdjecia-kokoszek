<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* ELEMENTY */
const gallery = document.getElementById("gallery");
const authBox = document.getElementById("authBox");
const userBox = document.getElementById("userBox");
const uploadBox = document.getElementById("uploadBox");
const userEmail = document.getElementById("userEmail");

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDskXdRJfexDefGsNWedNQA2VWN8KUKJ9Q",
  authDomain: "zdjecia-kokoszek2137.firebaseapp.com",
  projectId: "zdjecia-kokoszek2137",
  storageBucket: "zdjecia-kokoszek2137.appspot.com",
  messagingSenderId: "936920168632",
  appId: "1:936920168632:web:0469dce19d9d4a5ab25c4d"
};

/* INIT */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let isIncognito = false;
const ADMIN_EMAIL = "szkiarszys@gmail.com";

/* AUTH */
window.register = async () => {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  if (!email || !pass) return alert("Wpisz email i hasło");
  const res = await createUserWithEmailAndPassword(auth, email, pass);
  await sendEmailVerification(res.user);
  alert("Sprawdź maila i potwierdź konto");
};

window.login = async () => {
  await signInWithEmailAndPassword(
    auth,
    document.getElementById("email").value,
    document.getElementById("password").value
  );
};

window.logout = async () => signOut(auth);

window.incognito = () => {
  isIncognito = true;
  authBox.classList.add("hidden");
  loadGallery();
};

/* STATE */
onAuthStateChanged(auth, user => {
  currentUser = user;
  if (user) {
    isIncognito = false;
    authBox.classList.add("hidden");
    userBox.classList.remove("hidden");
    userEmail.textContent = user.email;
    if (user.email === ADMIN_EMAIL) uploadBox.classList.remove("hidden");
    loadGallery();
  }
});

/* UPLOAD */
window.uploadPhoto = async () => {
  const file = document.getElementById("photoFile").files[0];
  const r = ref(storage, "photos/" + Date.now());
  await uploadBytes(r, file);
  const url = await getDownloadURL(r);

  await addDoc(collection(db, "photos"), {
    name: photoName.value,
    desc: photoDesc.value,
    url,
    ratings: [],
    comments: []
  });
  loadGallery();
};

/* GALLERY */
async function loadGallery() {
  gallery.innerHTML = "";
  const snap = await getDocs(collection(db, "photos"));
  snap.forEach(d => {
    const p = d.data();
    const avg = p.ratings.length ? (p.ratings.reduce((a,b)=>a+b)/p.ratings.length).toFixed(1) : "brak";
    gallery.innerHTML += `
      <div class="box">
        <h3>${p.name}</h3>
        <p>${p.desc}</p>
        <img src="${p.url}">
        ⭐ ${avg}
      </div>`;
  });
}
</script>




