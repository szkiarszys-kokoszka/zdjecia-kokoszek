<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Zdjƒôcia kokoszek i nie tylko</title>
  <style>
    body { font-family: Arial; background:#f5f5f5; padding:20px }
    .box { background:white; padding:15px; margin-bottom:15px; border-radius:8px }
    button { margin:5px }
    img { max-width:300px; display:block }
    .hidden { display:none }
  </style>
</head>
<body>

<h1>üêî Zdjƒôcia kokoszek i nie tylko</h1>

<div class="box" id="authBox">
  <input id="email" placeholder="email"><br>
  <input id="password" type="password" placeholder="has≈Ço"><br>
  <button onclick="register()">Rejestracja</button>
  <button onclick="login()">Logowanie</button>
  <button onclick="incognito()">Tryb incognito</button>
</div>

<div class="box hidden" id="userBox">
  Zalogowany jako: <span id="userEmail"></span>
  <button onclick="logout()">Wyloguj</button>
</div>

<div class="box hidden" id="uploadBox">
  <h3>Dodaj zdjƒôcie</h3>
  <input id="photoName" placeholder="Nazwa zdjƒôcia"><br>
  <textarea id="photoDesc" placeholder="Opis"></textarea><br>
  <input type="file" id="photoFile"><br>
  <button onclick="uploadPhoto()">Dodaj</button>
</div>

<div id="gallery"></div>

<script type="module">
// ELEMENTY HTML
const gallery = document.getElementById("gallery");
const authBox = document.getElementById("authBox");
const userBox = document.getElementById("userBox");
const uploadBox = document.getElementById("uploadBox");
const userEmail = document.getElementById("userEmail");

// IMPORTY FIREBASE
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

// KONFIG FIREBASE
const firebaseConfig = {
  apiKey: "TU_WKLEJ_SW√ìJ_API_KEY",
  authDomain: "TU_WKLEJ_SW√ìJ_AUTH_DOMAIN",
  projectId: "TU_WKLEJ_SW√ìJ_PROJECT_ID",
  storageBucket: "TU_WKLEJ_SW√ìJ_STORAGE_BUCKET",
  messagingSenderId: "TU_WKLEJ_SW√ìJ_SENDER_ID",
  appId: "TU_WKLEJ_SW√ìJ_APP_ID"
};

// INICJALIZACJA
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
let isIncognito = false;
const ADMIN_EMAIL = "szkiarszys@gmail.com";

// REJESTRACJA
window.register = async () => {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  if (!email || !pass) return alert("Wpisz email i has≈Ço");

  const res = await createUserWithEmailAndPassword(auth, email, pass);
  await sendEmailVerification(res.user);
  alert("Sprawd≈∫ maila i kliknij link weryfikacyjny");
};

// LOGOWANIE
window.login = async () => {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  await signInWithEmailAndPassword(auth, email, pass);
};

// WYLOGUJ
window.logout = async () => {
  await signOut(auth);
};

// TRYB INCOGNITO
window.incognito = () => {
  isIncognito = true;
  authBox.classList.add("hidden");
  userBox.classList.add("hidden");
  uploadBox.classList.add("hidden");
  loadGallery();
};

// OBS≈ÅUGA STANU ZALOGOWANIA
onAuthStateChanged(auth, user => {
  currentUser = user;
  if (user) {
    isIncognito = false;
    authBox.classList.add("hidden");
    userBox.classList.remove("hidden");
    userEmail.textContent = user.email;
    uploadBox.classList.toggle(user.email === ADMIN_EMAIL);
    loadGallery();
  } else {
    userBox.classList.add("hidden");
    uploadBox.classList.add("hidden");
  }
});

// DODAWANIE ZDJƒòƒÜ
window.uploadPhoto = async () => {
  const file = document.getElementById("photoFile").files[0];
  if (!file) return alert("Wybierz plik!");
  const name = document.getElementById("photoName").value || "Bez nazwy";
  const desc = document.getElementById("photoDesc").value || "";

  const r = ref(storage, "photos/" + Date.now());
  await uploadBytes(r, file);
  const url = await getDownloadURL(r);

  await addDoc(collection(db, "photos"), {
    name,
    desc,
    url,
    ratings: [],
    comments: []
  });
  loadGallery();
};

// WYSWIETLANIE GALERII
async function loadGallery() {
  gallery.innerHTML = "";
  const snap = await getDocs(collection(db, "photos"));
  snap.forEach(d => {
    const p = d.data();
    const avg = p.ratings.length ? (p.ratings.reduce((a,b)=>a+b)/p.ratings.length).toFixed(1) : "brak";

    const div = document.createElement("div");
    div.className = "box";
    div.innerHTML = `
      <h3>${p.name}</h3>
      <p>${p.desc}</p>
      <img src="${p.url}">
      ‚≠ê ≈örednia: ${avg}<br>
      ${!isIncognito && currentUser ? `
        Oce≈Ñ:
        <select onchange="rate('${d.id}', this.value)">
          <option></option>
          <option>0</option><option>1</option><option>2</option>
          <option>3</option><option>4</option><option>5</option>
        </select><br>
        <input placeholder="Komentarz" onkeydown="if(event.key==='Enter')comment('${d.id}',this.value)">
      ` : `<i>Tryb incognito ‚Äì tylko podglƒÖd</i>`}
      ${currentUser?.email===ADMIN_EMAIL ? `<button onclick="del('${d.id}')">Usu≈Ñ</button>`:""}
    `;
    gallery.appendChild(div);
  });
}

// OCENIANIE
window.rate = async (id, val) => {
  if (!val) return;
  const refd = doc(db,"photos",id);
  const snap = await getDocs(collection(db,"photos"));
  snap.forEach(async d => {
    if(d.id===id){
      const arr=[...d.data().ratings, Number(val)];
      await updateDoc(refd,{ratings:arr});
      loadGallery();
    }
  });
};

// KOMENTARZE
window.comment = async (id, text) => {
  if (!text) return;
  const refd = doc(db,"photos",id);
  const snap = await getDocs(collection(db,"photos"));
  snap.forEach(async d => {
    if(d.id===id){
      const arr=[...(d.data().comments||[]), text];
      await updateDoc(refd,{comments:arr});
      loadGallery();
    }
  });
};

// USUWANIE ZDJƒòƒÜ
window.del = async id => {
  await deleteDoc(doc(db,"photos",id));
  loadGallery();
};
</script>

</body>
</html>







